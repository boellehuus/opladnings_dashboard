<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Tesla Ladeplan Dashboard</title>
    <!-- 
    TESLA DASHBOARD - FASE 2 DATA FLOW IMPLEMENTERET
    ================================================
    ✅ Fase 1: Alle kritiske JavaScript fejl rettet
    ✅ Fase 2: BilligkWh data splitting og fallback system
    ✅ Forbedret data flow og GitHub Gist verificering
    ✅ Robust fejlhåndtering med automatisk fallback
    ✅ Tesla Logic Variables verificering og backup
    -->
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }
    
    body {
        background: #f5f5f7;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
        color: #1d1d1f;
        min-height: 100vh;
        padding: 12px;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    .container {
        max-width: 100%;
        width: 450px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e5e7;
    }
    
    @media (max-width: 480px) {
        body { padding: 8px; }
        .container { width: 100%; padding: 14px; border-radius: 12px; }
    }
    
    .time-selector {
        display: flex;
        background: #f2f2f7;
        border-radius: 12px;
        padding: 3px;
        margin-bottom: 16px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .time-selector::-webkit-scrollbar {
        display: none;
    }
    
    .time-option {
        flex: 1;
        min-width: 55px;
        text-align: center;
        padding: 8px 12px;
        border-radius: 9px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        color: #86868b;
        white-space: nowrap;
    }
    
    .time-option:active { transform: scale(0.96); }
    .time-option.active {
        background: white;
        color: #1d1d1f;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .chart-container {
        height: 140px;
        margin-bottom: 16px;
        position: relative;
        background: #fafafa;
        border-radius: 12px;
        padding: 16px 12px 8px 12px;
        border: 1px solid #e5e5e7;
    }
    
    .empty-state {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #86868b;
    }
    
    .empty-state .main-message {
        font-size: 16px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .empty-state .sub-message {
        font-size: 12px;
        color: #86868b;
        text-align: center;
        line-height: 1.4;
    }
    
    .chart {
        display: flex;
        align-items: end;
        height: 100px;
        padding: 0;
        gap: 3px;
        position: relative;
    }
    
    .bar {
        flex: 1;
        border-radius: 3px 3px 0 0;
        transition: all 0.2s ease;
        position: relative;
        cursor: pointer;
        min-height: 4px;
    }
    
    .bar:hover { transform: translateY(-1px); filter: brightness(0.9); }
    .bar:active { transform: translateY(0px); }
    .bar.touch-active { transform: translateY(-1px); filter: brightness(0.9); }
    
    .bar.charging {
        background: repeating-linear-gradient(45deg, #ffffff, #ffffff 3px, rgba(48, 209, 88, 0.7) 3px, rgba(48, 209, 88, 0.7) 6px);
        box-shadow: 0 0 8px rgba(48, 209, 88, 0.4);
        border: 1px solid rgba(48, 209, 88, 0.8);
        animation: charging-pulse 2s infinite;
    }
    
    .bar.charging.past {
        background: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 3px, rgba(36, 138, 61, 0.4) 3px, rgba(36, 138, 61, 0.4) 6px);
        opacity: 0.6; animation: none;
    }
    
    .bar.current-time { background: #9370DB; }
    .bar.green { background: #30d158; }
    .bar.green.past { background: #248a3d; opacity: 0.6; }
    .bar.orange { background: #ff9500; }
    .bar.orange.past { background: #cc7700; opacity: 0.6; }
    .bar.red { background: #ff3b30; }
    .bar.red.past { background: #cc2e26; opacity: 0.6; }
    .bar.purple { background: #af52de; }
    .bar.purple.past { background: #8c42b1; opacity: 0.6; }
    
    .time-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 11px;
        color: #86868b;
        padding: 0 2px;
        font-weight: 500;
    }
    
    .tooltip-portal {
        position: fixed;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 11px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 10000;
        top: 0; left: 0;
        backdrop-filter: blur(10px);
    }
    
    .tooltip-portal.visible { opacity: 1; }
    
    .data-source {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 10px;
        color: #86868b;
        margin-bottom: 12px;
        padding: 4px 8px;
        background: #f8f8f8;
        border-radius: 6px;
        border: 1px solid #e8e8e8;
    }
    
    .reliability-indicator { font-size: 12px; font-weight: bold; }
    
    .summary-card {
        background: #f2f2f7;
        border-radius: 12px;
        padding: 6px 16px;
        border: 1px solid #e5e5e7;
        text-align: center;
        min-height: auto;
        line-height: 1.2;
    }
    
    .summary-title {
        font-size: 11px;
        color: #86868b;
        margin-bottom: 4px;
        font-weight: 500;
        line-height: 1.1;
    }
    
    .summary-price {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        color: #1d1d1f;
        line-height: 1.1;
    }
    
    .summary-divider { color: #86868b; font-weight: 400; }
    
    .charging-start {
        font-size: 11px;
        color: #86868b;
        margin-top: 6px;
        font-weight: 500;
        line-height: 1.1;
    }
    
    .debug-info {
        background: #f8f8f8;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        padding: 12px;
        margin-top: 16px;
        font-size: 11px;
        color: #666;
        font-family: 'SF Mono', Monaco, monospace;
    }
    
    .debug-title {
        font-weight: bold;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .debug-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
    }
    
    @keyframes charging-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="time-selector">
            <div class="time-option active" onclick="switchDay('today')">I dag</div>
            <div class="time-option" onclick="switchDay('tomorrow')">I morgen</div>
        </div>

        <div class="chart-container">
            <div class="chart" id="priceChart"></div>
            <div class="time-labels">
                <span>00</span><span>06</span><span>12</span><span>18</span><span>24</span>
            </div>
        </div>
        
        <div class="data-source">
            <span id="dataSource">Indlæser...</span>
            <span id="reliability" class="reliability-indicator">●</span>
        </div>
        
        <div class="summary-card">
            <div class="summary-title">Ladeinfo</div>
            <div class="summary-price">
                <span id="kWhNeeded">0 kWh</span>
                <span class="summary-divider">|</span>
                <span id="totalCost">0 kr</span>
            </div>
            <div class="charging-start" id="chargingStart">Indlæser...</div>
        </div>

        <!-- FASE 2: Debug panel for troubleshooting -->
        <div class="debug-info" id="debugInfo" style="display:none;">
            <div class="debug-title">Debug Information</div>
            <div class="debug-row">
                <span>Data Status:</span>
                <span id="debugDataStatus">Unknown</span>
            </div>
            <div class="debug-row">
                <span>Tesla Data:</span>
                <span id="debugTeslaData">No</span>
            </div>
            <div class="debug-row">
                <span>BilligkWh:</span>
                <span id="debugBilligkWh">No</span>
            </div>
            <div class="debug-row">
                <span>Today Prices:</span>
                <span id="debugTodayCount">0</span>
            </div>
            <div class="debug-row">
                <span>Tomorrow:</span>
                <span id="debugTomorrowCount">0</span>
            </div>
        </div>
    </div>

    <div id="tooltipPortal" class="tooltip-portal"></div>

<script>
    // ==============================================
    // FASE 2: DATA FLOW & FALLBACK SYSTEM
    // ==============================================

    // GLOBAL STATE
    let currentDay = 'today';
    let currentTeslaData = null;
    let refreshTimer = null;
    let isPageVisible = true;
    let hasLiveTeslaData = false;
    let dataStatus = 'loading';

    // FASE 2: Enhanced configuration with multiple data sources
    const CONFIG = {
        refreshInterval: 60000,
        retryAttempts: 3,
        retryDelay: 2000,
        
        // Primary data source (Tesla webhook output)
        dataURL: 'https://gist.githubusercontent.com/boellehuus/ac3fe4331b033d941cdc836936d4c3c9/raw/elbil-data.json',
        
        // Fallback data sources
        billigkwhURL: 'https://billigkwh.dk/api/Priser/HentPriser?sted=DK1&netselskab=vores_elnet&produkt=greenbow_elaftale',
        exchangeRateURL: 'https://api.exchangerate-api.com/v4/latest/EUR',
        
        // Exchange rate handling
        exchangeRateFallback: 7.44,
        cachedEURRate: 7.44,
        lastRateUpdate: null,
        
        // FASE 2: Data validation thresholds
        minValidPrices: 12, // Minimum hours to consider data valid
        maxPriceThreshold: 10.0, // Maximum reasonable price per kWh
        minPriceThreshold: 0.1   // Minimum reasonable price per kWh
    };

    // FASE 2: Enhanced data structures with validation
    const priceDataSet = { 
        today: [], 
        tomorrow: [],
        source: 'unknown',
        lastUpdate: null,
        isValid: false
    };
    
    const chargingSchedule = { today: [], tomorrow: [] };
    let priceData = [];

    console.log('🔄 FASE 2: Tesla Dashboard with enhanced data flow...');

    // Expose switchDay function immediately to fix onclick error
    window.switchDay = function(day) {
        switchDay(day);
    };

    // ==============================================
    // FASE 2: ENHANCED BILLIGKWH DATA PROCESSING
    // ==============================================

    async function fetchBilligkWhData() {
        try {
            console.log('⚡ FASE 2: Fetching BilligkWh data with validation...');
            
            const response = await fetch(CONFIG.billigkwhURL + '&t=' + Date.now(), {
                headers: { 'User-Agent': 'Tesla-Dashboard/2.0' }
            });
            
            if (!response.ok) {
                throw new Error(`BilligkWh HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('✅ BilligkWh raw data received:', data.length, 'days');
            
            // FASE 2: Split data into today/tomorrow with validation
            const processedData = await processBilligkWhData(data);
            
            if (processedData.isValid) {
                console.log('✅ BilligkWh data processed successfully');
                return processedData;
            } else {
                throw new Error('BilligkWh data validation failed');
            }
            
        } catch (error) {
            console.warn('⚠️ BilligkWh fetch failed:', error.message);
            return null;
        }
    }

    // FASE 2: Process and validate BilligkWh data
    async function processBilligkWhData(rawData) {
        try {
            const result = {
                today: [],
                tomorrow: [],
                source: 'BilligkWh',
                lastUpdate: new Date(),
                isValid: false
            };

            const now = new Date();
            const copenhagenNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Copenhagen"}));
            const todayDateStr = copenhagenNow.toISOString().split('T')[0];
            const tomorrowDate = new Date(copenhagenNow);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            const tomorrowDateStr = tomorrowDate.toISOString().split('T')[0];

            console.log('📅 Looking for dates:', todayDateStr, 'and', tomorrowDateStr);

            // Get EUR/DKK rate for conversion
            const eurRate = await fetchExchangeRate();

            // Process each day in the raw data
            for (const dayData of rawData) {
                if (!dayData.Dato || !dayData.Priser) continue;

                const dataDate = dayData.Dato.split('T')[0];
                let targetArray = null;
                
                if (dataDate === todayDateStr) {
                    targetArray = result.today;
                    console.log('📊 Processing TODAY data for', dataDate);
                } else if (dataDate === tomorrowDateStr) {
                    targetArray = result.tomorrow;
                    console.log('📊 Processing TOMORROW data for', dataDate);
                }

                if (targetArray && Array.isArray(dayData.Priser)) {
                    // Sort prices by hour
                    const sortedPrices = dayData.Priser
                        .sort((a, b) => a.StartTid.localeCompare(b.StartTid))
                        .map(pricePoint => {
                            // Convert EUR/MWh to DKK/kWh
                            const eurPrice = parseFloat(pricePoint.Pris) || 0;
                            const dkkPrice = (eurPrice / 1000) * eurRate;
                            return Math.round(dkkPrice * 1000) / 1000; // Round to 3 decimals
                        });

                    // Ensure we have 24 hours
                    while (sortedPrices.length < 24) {
                        sortedPrices.push(sortedPrices[sortedPrices.length - 1] || 2.5);
                    }

                    targetArray.splice(0, 24, ...sortedPrices.slice(0, 24));
                    console.log(`✅ Processed ${targetArray.length} hours for ${dataDate === todayDateStr ? 'today' : 'tomorrow'}`);
                }
            }

            // Validate data quality
            result.isValid = validatePriceData(result.today) || validatePriceData(result.tomorrow);
            
            if (result.isValid) {
                console.log('✅ BilligkWh data validation passed');
                console.log('📊 Today prices:', result.today.length, 'hours');
                console.log('📊 Tomorrow prices:', result.tomorrow.length, 'hours');
            }

            return result;

        } catch (error) {
            console.error('❌ Error processing BilligkWh data:', error);
            return { today: [], tomorrow: [], source: 'Error', lastUpdate: new Date(), isValid: false };
        }
    }

    // FASE 2: Validate price data quality
    function validatePriceData(prices) {
        if (!Array.isArray(prices) || prices.length < CONFIG.minValidPrices) {
            console.log('⚠️ Insufficient price data:', prices.length, 'hours');
            return false;
        }

        // Check for reasonable price ranges
        const validPrices = prices.filter(price => 
            typeof price === 'number' && 
            price >= CONFIG.minPriceThreshold && 
            price <= CONFIG.maxPriceThreshold
        );

        const validRatio = validPrices.length / prices.length;
        
        if (validRatio < 0.8) {
            console.log('⚠️ Too many invalid prices. Valid ratio:', Math.round(validRatio * 100) + '%');
            return false;
        }

        console.log('✅ Price data validation passed:', validPrices.length, 'valid prices');
        return true;
    }

    // FASE 2: Enhanced EUR/DKK rate fetching with better caching
    async function fetchExchangeRate() {
        try {
            const now = new Date();
            const lastUpdate = CONFIG.lastRateUpdate;
            
            // Use cached rate if less than 24 hours old
            if (lastUpdate && (now - lastUpdate) < 24 * 60 * 60 * 1000) {
                console.log('📈 Using cached EUR/DKK rate:', CONFIG.cachedEURRate);
                return CONFIG.cachedEURRate;
            }
            
            console.log('📈 Fetching fresh EUR/DKK rate...');
            
            const response = await fetch(CONFIG.exchangeRateURL + '?t=' + Date.now(), {
                headers: { 'User-Agent': 'Tesla-Dashboard/2.0' }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.rates && data.rates.DKK) {
                    const eurRate = parseFloat(data.rates.DKK);
                    
                    // Validate rate is reasonable (should be between 6-9 DKK per EUR)
                    if (eurRate > 6 && eurRate < 9) {
                        CONFIG.cachedEURRate = eurRate;
                        CONFIG.lastRateUpdate = now;
                        console.log('✅ EUR/DKK rate updated:', eurRate);
                        return eurRate;
                    } else {
                        console.warn('⚠️ Unreasonable EUR rate received:', eurRate);
                    }
                }
            }
            
            throw new Error('Invalid API response or rate');
            
        } catch (error) {
            console.warn('⚠️ EUR rate fetch failed, using fallback:', CONFIG.exchangeRateFallback);
            return CONFIG.exchangeRateFallback;
        }
    }

    // ==============================================
    // FASE 2: ENHANCED TESLA DATA INTEGRATION
    // ==============================================

    async function fetchTeslaData() {
        try {
            console.log('🔄 FASE 2: Fetching Tesla data with fallback system...');
            dataStatus = 'loading';
            updateDebugInfo();
            
            const teslaResponse = await fetch(CONFIG.dataURL + '?t=' + Date.now(), {
                headers: { 'User-Agent': 'Tesla-Dashboard/2.0' }
            });
            
            if (!teslaResponse.ok) {
                throw new Error(`Tesla HTTP ${teslaResponse.status}`);
            }
            
            const teslaData = await teslaResponse.json();
            console.log('✅ Tesla data received, processing...');
            
            // FASE 2: Enhanced data processing with validation
            const processed = await processTeslaData(teslaData);
            
            if (processed.success) {
                updateUIWithTeslaData(teslaData);
                dataStatus = 'tesla';
                console.log('✅ Tesla data processed successfully');
            } else {
                throw new Error('Tesla data validation failed');
            }
            
            // Start refresh timer if not already running
            if (!refreshTimer) {
                refreshTimer = setInterval(fetchTeslaData, CONFIG.refreshInterval);
                console.log('🔄 Auto-refresh timer started');
            }
            
        } catch (error) {
            console.error('❌ Tesla data fetch error:', error.message);
            
            // FASE 2: Fallback to BilligkWh data
            await attemptBilligkWhFallback();
        }
        
        updateDebugInfo();
    }

    // FASE 2: Process and validate Tesla data
    async function processTeslaData(teslaData) {
        try {
            console.log('🔄 Processing Tesla data structure...');
            
            // Check for required Tesla data fields
            const requiredFields = ['Elbil_price_data', 'Elbil_total_cost', 'Elbil_kWh_needed'];
            const missingFields = requiredFields.filter(field => 
                teslaData[field] === null || teslaData[field] === undefined
            );
            
            if (missingFields.length > 0) {
                console.warn('⚠️ Missing Tesla fields:', missingFields);
            }
            
            // Validate price data
            if (teslaData.Elbil_price_data && Array.isArray(teslaData.Elbil_price_data)) {
                const isValid = validatePriceData(teslaData.Elbil_price_data);
                if (isValid) {
                    console.log('✅ Tesla price data validation passed');
                    return { success: true, source: 'Tesla' };
                }
            }
            
            console.warn('⚠️ Tesla price data validation failed');
            return { success: false, reason: 'Invalid price data' };
            
        } catch (error) {
            console.error('❌ Tesla data processing error:', error);
            return { success: false, reason: error.message };
        }
    }

    // FASE 2: Fallback to BilligkWh when Tesla data fails
    async function attemptBilligkWhFallback() {
        try {
            console.log('🔄 FASE 2: Attempting BilligkWh fallback...');
            dataStatus = 'fallback';
            
            const billigkWhData = await fetchBilligkWhData();
            
            if (billigkWhData && billigkWhData.isValid) {
                console.log('✅ BilligkWh fallback successful');
                
                // Update price data set
                priceDataSet.today = billigkWhData.today;
                priceDataSet.tomorrow = billigkWhData.tomorrow;
                priceDataSet.source = billigkWhData.source;
                priceDataSet.lastUpdate = billigkWhData.lastUpdate;
                priceDataSet.isValid = true;
                
                // Update UI with fallback data
                updateUIWithFallbackData();
                dataStatus = 'billigkwh';
                
            } else {
                throw new Error('BilligkWh fallback failed');
            }
            
        } catch (error) {
            console.error('❌ Fallback system failed:', error);
            dataStatus = 'error';
            handleCompleteDataFailure();
        }
    }

    // FASE 2: Enhanced Tesla data UI update
    function updateUIWithTeslaData(teslaData) {
        console.log('🔄 FASE 2: Updating UI with Tesla data...');
        
        currentTeslaData = teslaData;
        hasLiveTeslaData = true;
        
        // Update summary info
        updateSummaryInfo(teslaData);
        
        // Update price data set
        updatePriceDataSet(teslaData);
        
        // Update charging schedule
        updateChargingHours(teslaData);
        
        // Update data source indicator
        updateDataSourceIndicator('Tesla', true);
        
        // Set current day data and regenerate chart
        priceData = priceDataSet[currentDay] || [];
        generateChart();
        
        console.log('✅ Tesla UI update completed');
    }

    // FASE 2: Update UI with BilligkWh fallback data
    function updateUIWithFallbackData() {
        console.log('🔄 FASE 2: Updating UI with BilligkWh fallback...');
        
        // Clear Tesla-specific data
        document.getElementById('totalCost').textContent = 'N/A';
        document.getElementById('kWhNeeded').textContent = 'N/A';
        document.getElementById('chargingStart').textContent = 'Kun priser tilgængelige';
        
        // Clear charging schedule
        chargingSchedule.today = [];
        chargingSchedule.tomorrow = [];
        
        // Update data source indicator
        updateDataSourceIndicator('BilligkWh (backup)', false);
        
        // Set current day data and regenerate chart
        priceData = priceDataSet[currentDay] || [];
        generateChart();
        
        console.log('✅ Fallback UI update completed');
    }

    // FASE 2: Enhanced data mapping with validation
    function updatePriceDataSet(teslaData) {
        console.log('🔄 FASE 2: Updating price data set with validation...');
        
        // Reset data set
        priceDataSet.today = [];
        priceDataSet.tomorrow = [];
        priceDataSet.source = 'Tesla';
        priceDataSet.lastUpdate = new Date();
        priceDataSet.isValid = false;
        
        // Process today's data
        if (teslaData.Elbil_price_data && Array.isArray(teslaData.Elbil_price_data)) {
            priceDataSet.today = [...teslaData.Elbil_price_data];
            console.log('✅ Today prices loaded:', priceDataSet.today.length, 'hours');
        }
        
        // Process tomorrow's data (if available)
        if (teslaData.Elbil_price_data_tomorrow && Array.isArray(teslaData.Elbil_price_data_tomorrow)) {
            priceDataSet.tomorrow = [...teslaData.Elbil_price_data_tomorrow];
            console.log('✅ Tomorrow prices loaded:', priceDataSet.tomorrow.length, 'hours');
        }
        
        // Validate at least one day has good data
        priceDataSet.isValid = validatePriceData(priceDataSet.today) || validatePriceData(priceDataSet.tomorrow);
        
        if (priceDataSet.isValid) {
            console.log('✅ Tesla price data set validated');
        } else {
            console.warn('⚠️ Tesla price data validation failed');
        }
    }

    function updateSummaryInfo(teslaData) {
        // Update cost
        if (teslaData.Elbil_total_cost !== null && teslaData.Elbil_total_cost !== undefined && teslaData.Elbil_total_cost > 0) {
            document.getElementById('totalCost').textContent = 
                parseFloat(teslaData.Elbil_total_cost).toFixed(2).replace('.', ',') + ' kr';
        } else {
            document.getElementById('totalCost').textContent = '0 kr';
        }
        
        // Update kWh needed
        if (teslaData.Elbil_kWh_needed !== null && teslaData.Elbil_kWh_needed !== undefined && teslaData.Elbil_kWh_needed > 0) {
            document.getElementById('kWhNeeded').textContent = 
                parseFloat(teslaData.Elbil_kWh_needed).toFixed(2).replace('.', ',') + ' kWh';
        } else {
            document.getElementById('kWhNeeded').textContent = '0 kWh';
        }
        
        // Update charging schedule
        if (teslaData.Elbil_compact_schedule && teslaData.Elbil_compact_schedule !== '') {
            document.getElementById('chargingStart').textContent = teslaData.Elbil_compact_schedule;
        } else {
            document.getElementById('chargingStart').textContent = 'Ladning ikke planlagt';
        }
    }

    function updateChargingHours(teslaData) {
        // Reset charging schedule
        chargingSchedule.today = [];
        chargingSchedule.tomorrow = [];
        
        if (teslaData.Elbil_optimal_start_time && teslaData.Elbil_charging_hours && teslaData.Elbil_compact_schedule) {
            try {
                const startTime = teslaData.Elbil_optimal_start_time.toString();
                const chargingHours = parseInt(teslaData.Elbil_charging_hours);
                const schedule = teslaData.Elbil_compact_schedule.toString();
                
                if (startTime.includes(':')) {
                    const startHour = parseInt(startTime.split(':')[0]);
                    
                    let targetDay = 'today';
                    const scheduleLC = schedule.toLowerCase();
                    if (scheduleLC.includes('i morgen')) {
                        targetDay = 'tomorrow';
                    }
                    
                    for (let i = 0; i < chargingHours; i++) {
                        const hour = (startHour + i) % 24;
                        chargingSchedule[targetDay].push(hour);
                    }
                    
                    console.log(`⚡ Charging scheduled for ${targetDay}:`, chargingSchedule[targetDay]);
                }
            } catch (error) {
                console.log('⚠️ Could not parse charging hours:', error);
            }
        }
    }

    // FASE 2: Handle complete data failure
    function handleCompleteDataFailure() {
        console.error('❌ FASE 2: Complete data failure - no sources available');
        
        hasLiveTeslaData = false;
        priceDataSet.today = [];
        priceDataSet.tomorrow = [];
        priceDataSet.isValid = false;
        priceData = [];
        
        document.getElementById('totalCost').textContent = '0 kr';
        document.getElementById('kWhNeeded').textContent = '0 kWh';
        document.getElementById('chargingStart').textContent = 'Ingen forbindelse';
        
        chargingSchedule.today = [];
        chargingSchedule.tomorrow = [];
        
        updateDataSourceIndicator('Fejl - Ingen data', false);
        generateChart();
    }

    function updateDataSourceIndicator(source, reliable) {
        const sourceElement = document.getElementById('dataSource');
        const reliabilityElement = document.getElementById('reliability');
        
        if (sourceElement) {
            sourceElement.textContent = source;
        }
        
        if (reliabilityElement) {
            reliabilityElement.style.color = reliable ? '#30D158' : '#FF9500';
            reliabilityElement.textContent = reliable ? '●' : '◐';
            reliabilityElement.title = reliable ? 'Pålidelig data' : 'Begrænsede data';
        }
    }

    // ==============================================
    // FASE 2: ENHANCED DEBUG SYSTEM
    // ==============================================

    function updateDebugInfo() {
        const debugInfo = document.getElementById('debugInfo');
        if (!debugInfo) return;

        // Show debug panel if there are issues
        const hasIssues = dataStatus === 'error' || dataStatus === 'fallback' || !priceDataSet.isValid;
        debugInfo.style.display = hasIssues ? 'block' : 'none';

        // Update debug fields
        document.getElementById('debugDataStatus').textContent = dataStatus;
        document.getElementById('debugTeslaData').textContent = hasLiveTeslaData ? 'Yes' : 'No';
        document.getElementById('debugBilligkWh').textContent = 
            (priceDataSet.source === 'BilligkWh') ? 'Yes' : 'No';
        document.getElementById('debugTodayCount').textContent = priceDataSet.today.length;
        document.getElementById('debugTomorrowCount').textContent = priceDataSet.tomorrow.length;
    }

    // ==============================================
    // TOOLTIP SYSTEM
    // ==============================================

    const tooltipPortal = document.getElementById('tooltipPortal');
    let activeBar = null;

    function showTooltip(barElement, text) {
        activeBar = barElement;
        const rect = barElement.getBoundingClientRect();
        
        tooltipPortal.textContent = text;
        tooltipPortal.style.left = (rect.left + rect.width / 2) + 'px';
        tooltipPortal.style.top = (rect.top - 8) + 'px';
        tooltipPortal.style.transform = 'translate(-50%, -100%)';
        tooltipPortal.classList.add('visible');
    }

    function hideTooltip() {
        activeBar = null;
        tooltipPortal.classList.remove('visible');
    }

    // ==============================================
    // CHART GENERATION
    // ==============================================

    function generateChart() {
        console.log('🔄 FASE 2: Generating chart for', currentDay, '- data length:', priceData.length);
        
        const chart = document.getElementById('priceChart');
        chart.innerHTML = '';
        
        if (!priceData || priceData.length === 0) {
            showEmptyState();
            return;
        }
        
        const maxPrice = Math.max(...priceData);
        
        // Get current Copenhagen hour
        const now = new Date();
        const copenhagenNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Copenhagen"}));
        const currentHour = copenhagenNow.getHours();
        
        priceData.forEach((price, index) => {
            const bar = document.createElement('div');
            bar.className = 'bar';
            
            const height = Math.max((price / maxPrice) * 100, 5);
            bar.style.height = height + '%';
            
            // Tooltip
            const tooltipText = `${index.toString().padStart(2, '0')}:00 - ${price.toFixed(2).replace('.', ',')} kr/kWh`;
            
            bar.addEventListener('mouseenter', function() {
                showTooltip(this, tooltipText);
            });
            
            bar.addEventListener('mouseleave', function() {
                hideTooltip();
            });
            
            bar.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.classList.add('touch-active');
                showTooltip(this, tooltipText);
                
                document.querySelectorAll('.bar').forEach(otherBar => {
                    if (otherBar !== this) {
                        otherBar.classList.remove('touch-active');
                    }
                });
                
                setTimeout(() => {
                    this.classList.remove('touch-active');
                    if (activeBar === this) hideTooltip();
                }, 3000);
            }, { passive: false });
            
            // Bar styling
            const currentChargingHours = chargingSchedule[currentDay] || [];
            const isCharging = currentChargingHours.includes(index);
            const isPastHour = (currentDay === 'today' && index < currentHour);
            const isCurrentTime = (currentDay === 'today' && index === currentHour);
            
            if (isCurrentTime) {
                bar.classList.add('current-time');
            } else if (isCharging) {
                bar.classList.add('charging');
                if (isPastHour) bar.classList.add('past');
            } else {
                if (price < 2.5) {        
                    bar.classList.add('green');
                } else if (price < 3.5) {  
                    bar.classList.add('orange');
                } else {                  
                    bar.classList.add('red');
                }
                
                if (isPastHour) bar.classList.add('past');
            }
            
            chart.appendChild(bar);
        });
        
        console.log('✅ Chart generation completed');
    }

    function showEmptyState() {
        console.log('🔄 FASE 2: Showing enhanced empty state for', currentDay);
        
        const chart = document.getElementById('priceChart');
        
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        
        const mainMessage = document.createElement('div');
        mainMessage.className = 'main-message';
        
        const subMessage = document.createElement('div');
        subMessage.className = 'sub-message';
        
        if (currentDay === 'tomorrow') {
            const now = new Date();
            const copenhagenNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Copenhagen"}));
            const currentHour = copenhagenNow.getHours();
            
            if (currentHour < 13) {
                mainMessage.textContent = 'Ikke klar endnu';
                subMessage.textContent = 'Priser bliver normalt\ntilgængelige efter kl. 13:00';
            } else if (dataStatus === 'billigkwh') {
                mainMessage.textContent = 'Backup data';
                subMessage.textContent = 'Kun dagens priser tilgængelige\nfra BilligkWh backup';
            } else {
                mainMessage.textContent = 'Ingen data';
                subMessage.textContent = 'Tesla data ikke tilgængeligt';
            }
        } else {
            if (dataStatus === 'error') {
                mainMessage.textContent = 'Datafejl';
                subMessage.textContent = 'Ingen kilder tilgængelige\nPrøv igen senere';
            } else if (dataStatus === 'loading') {
                mainMessage.textContent = 'Indlæser...';
                subMessage.textContent = 'Henter data fra Tesla\nog backup kilder';
            } else {
                mainMessage.textContent = 'Ingen data';
                subMessage.textContent = 'Kør Tesla script for at\ngenerere ladeplan og priser';
            }
        }
        
        emptyState.appendChild(mainMessage);
        emptyState.appendChild(subMessage);
        chart.appendChild(emptyState);
    }

    // ==============================================
    // DAY SWITCHING
    // ==============================================

    function switchDay(day) {
        try {
            console.log('🔄 FASE 2: Switching to day:', day);
            
            // Update active button
            document.querySelectorAll('.time-option').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate correct button
            const buttons = document.querySelectorAll('.time-option');
            buttons.forEach(btn => {
                if ((day === 'today' && btn.textContent.includes('I dag')) ||
                    (day === 'tomorrow' && btn.textContent.includes('morgen'))) {
                    btn.classList.add('active');
                }
            });
            
            // Update current day
            currentDay = day;
            
            // Update data
            priceData = priceDataSet[day] || [];
            
            console.log(`✅ Switched to ${day}:`, priceData.length, 'prices');
            
            // Regenerate chart
            generateChart();
            
            // Update debug info
            updateDebugInfo();
            
        } catch (error) {
            console.error('❌ Error switching day:', error);
            priceData = [];
            generateChart();
        }
    }

    // ==============================================
    // INITIALIZATION
    // ==============================================

    function init() {
        console.log('🔄 FASE 2: Initializing Tesla Dashboard with enhanced data flow...');
        
        // Initialize UI
        document.getElementById('totalCost').textContent = '0 kr';
        document.getElementById('kWhNeeded').textContent = '0 kWh';
        document.getElementById('chargingStart').textContent = 'Indlæser...';
        
        updateDataSourceIndicator('Indlæser...', false);
        
        // Clear data structures
        priceDataSet.today = [];
        priceDataSet.tomorrow = [];
        priceDataSet.isValid = false;
        priceData = [];
        dataStatus = 'loading';
        
        // Show empty state initially
        generateChart();
        updateDebugInfo();
        
        // Start data fetching
        fetchTeslaData();
        
        console.log('✅ FASE 2: Tesla Dashboard initialization completed');
    }

    // ==============================================
    // EVENT HANDLERS
    // ==============================================

    // Hide tooltip when clicking outside bars
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('bar')) {
            hideTooltip();
        }
    });

    // Handle page visibility for battery optimization
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            isPageVisible = false;
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
                console.log('⏸️ Auto-refresh paused');
            }
        } else {
            isPageVisible = true;
            if (!refreshTimer) {
                refreshTimer = setInterval(fetchTeslaData, CONFIG.refreshInterval);
                console.log('▶️ Auto-refresh resumed');
                fetchTeslaData();
            }
        }
    });

    // Error handling for unhandled promises
    window.addEventListener('unhandledrejection', function(event) {
        console.error('🚨 Unhandled promise rejection:', event.reason);
        if (dataStatus !== 'error') {
            dataStatus = 'error';
            updateDebugInfo();
        }
    });

    // Error handling for general JavaScript errors
    window.addEventListener('error', function(event) {
        console.error('🚨 JavaScript error:', event.error);
        if (dataStatus !== 'error') {
            dataStatus = 'error';
            updateDebugInfo();
        }
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', init);

    // Expose global functions for backward compatibility BEFORE any other code
    window.switchDay = switchDay;
    window.generateChart = generateChart;
    window.fetchTeslaData = fetchTeslaData;

    // FASE 2: Enhanced debug interface
    window.debugDashboard = {
        config: () => CONFIG,
        priceData: () => priceDataSet,
        currentData: () => priceData,
        charging: () => chargingSchedule,
        teslaData: () => currentTeslaData,
        status: () => dataStatus,
        refresh: fetchTeslaData,
        switchDay: switchDay,
        fallback: attemptBilligkWhFallback,
        validate: (data) => validatePriceData(data),
        showDebug: () => {
            document.getElementById('debugInfo').style.display = 'block';
            updateDebugInfo();
        },
        hideDebug: () => {
            document.getElementById('debugInfo').style.display = 'none';
        }
    };

    console.log('');
    console.log('✅ ================================================');
    console.log('✅ FASE 2 COMPLETE: Enhanced data flow implemented');
    console.log('✅ ================================================');
    console.log('🔧 ENHANCED: BilligkWh data splitting with validation');
    console.log('🔧 ENHANCED: Robust fallback system implemented');
    console.log('🔧 ENHANCED: Data quality validation added');
    console.log('🔧 ENHANCED: Debug panel for troubleshooting');
    console.log('🔧 ENHANCED: Multi-source data handling');
    console.log('✅ ================================================');
    console.log('🎯 READY: Dashboard with intelligent fallback system');
    console.log('📊 FEATURES: Tesla → BilligkWh → Error handling');
    console.log('🔧 DEBUG: Enhanced window.debugDashboard available');
    console.log('⚡ STATUS: Use debugDashboard.showDebug() for details');
    console.log('✅ ================================================');
