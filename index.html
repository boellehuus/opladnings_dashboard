<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Tesla Ladeplan Dashboard</title>
    <!-- 
    TESLA DASHBOARD - FASE 2 FIXED: SIMPLE DATA FLOW + FALLBACK
    ===========================================================
    ‚úÖ Fase 1: Simple data flow som virkede (bibeholdt)
    ‚úÖ Fase 2: Fallback system tilf√∏jet (forenklet)
    ‚úÖ Tooltip: 2 decimaler implementeret
    ‚úÖ switchDay: Fejl rettet
    -->
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }
    
    body {
        background: #f5f5f7;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
        color: #1d1d1f;
        min-height: 100vh;
        padding: 12px;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    .container {
        max-width: 100%;
        width: 450px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e5e7;
    }
    
    @media (max-width: 480px) {
        body { padding: 8px; }
        .container { width: 100%; padding: 14px; border-radius: 12px; }
    }
    
    .time-selector {
        display: flex;
        background: #f2f2f7;
        border-radius: 12px;
        padding: 3px;
        margin-bottom: 16px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .time-selector::-webkit-scrollbar {
        display: none;
    }
    
    .time-option {
        flex: 1;
        min-width: 55px;
        text-align: center;
        padding: 8px 12px;
        border-radius: 9px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        color: #86868b;
        white-space: nowrap;
    }
    
    .time-option:active { transform: scale(0.96); }
    .time-option.active {
        background: white;
        color: #1d1d1f;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .chart-container {
        height: 140px;
        margin-bottom: 16px;
        position: relative;
        background: #fafafa;
        border-radius: 12px;
        padding: 16px 12px 8px 12px;
        border: 1px solid #e5e5e7;
    }
    
    .empty-state {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #86868b;
    }
    
    .empty-state .main-message {
        font-size: 16px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .empty-state .sub-message {
        font-size: 12px;
        color: #86868b;
        text-align: center;
        line-height: 1.4;
    }
    
    .chart {
        display: flex;
        align-items: end;
        height: 100px;
        padding: 0;
        gap: 3px;
        position: relative;
    }
    
    .bar {
        flex: 1;
        border-radius: 3px 3px 0 0;
        transition: all 0.2s ease;
        position: relative;
        cursor: pointer;
        min-height: 4px;
    }
    
    .bar:hover { transform: translateY(-1px); filter: brightness(0.9); }
    .bar:active { transform: translateY(0px); }
    .bar.touch-active { transform: translateY(-1px); filter: brightness(0.9); }
    
    .bar.charging {
        background: repeating-linear-gradient(45deg, #ffffff, #ffffff 3px, rgba(48, 209, 88, 0.7) 3px, rgba(48, 209, 88, 0.7) 6px);
        box-shadow: 0 0 8px rgba(48, 209, 88, 0.4);
        border: 1px solid rgba(48, 209, 88, 0.8);
        animation: charging-pulse 2s infinite;
    }
    
    .bar.charging.past {
        background: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 3px, rgba(36, 138, 61, 0.4) 3px, rgba(36, 138, 61, 0.4) 6px);
        opacity: 0.6; animation: none;
    }
    
    .bar.current-time { background: #9370DB; }
    .bar.green { background: #30d158; }
    .bar.green.past { background: #248a3d; opacity: 0.6; }
    .bar.orange { background: #ff9500; }
    .bar.orange.past { background: #cc7700; opacity: 0.6; }
    .bar.red { background: #ff3b30; }
    .bar.red.past { background: #cc2e26; opacity: 0.6; }
    .bar.purple { background: #af52de; }
    .bar.purple.past { background: #8c42b1; opacity: 0.6; }
    
    .time-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 11px;
        color: #86868b;
        padding: 0 2px;
        font-weight: 500;
    }
    
    .tooltip-portal {
        position: fixed;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 11px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 10000;
        top: 0; left: 0;
        backdrop-filter: blur(10px);
    }
    
    .tooltip-portal.visible { opacity: 1; }
    
    .data-source {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 10px;
        color: #86868b;
        margin-bottom: 12px;
        padding: 4px 8px;
        background: #f8f8f8;
        border-radius: 6px;
        border: 1px solid #e8e8e8;
    }
    
    .reliability-indicator { font-size: 12px; font-weight: bold; }
    
    .summary-card {
        background: #f2f2f7;
        border-radius: 12px;
        padding: 6px 16px;
        border: 1px solid #e5e5e7;
        text-align: center;
        min-height: auto;
        line-height: 1.2;
    }
    
    .summary-title {
        font-size: 11px;
        color: #86868b;
        margin-bottom: 4px;
        font-weight: 500;
        line-height: 1.1;
    }
    
    .summary-price {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        color: #1d1d1f;
        line-height: 1.1;
    }
    
    .summary-divider { color: #86868b; font-weight: 400; }
    
    .charging-start {
        font-size: 11px;
        color: #86868b;
        margin-top: 6px;
        font-weight: 500;
        line-height: 1.1;
    }
    
    @keyframes charging-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="time-selector">
            <div class="time-option active" onclick="switchDay('today')">I dag</div>
            <div class="time-option" onclick="switchDay('tomorrow')">I morgen</div>
        </div>

        <div class="chart-container">
            <div class="chart" id="priceChart"></div>
            <div class="time-labels">
                <span>00</span><span>06</span><span>12</span><span>18</span><span>24</span>
            </div>
        </div>
        
        <div class="data-source">
            <span id="dataSource">Indl√¶ser...</span>
            <span id="reliability" class="reliability-indicator">‚óè</span>
        </div>
        
        <div class="summary-card">
            <div class="summary-title">Ladeinfo</div>
            <div class="summary-price">
                <span id="kWhNeeded">0 kWh</span>
                <span class="summary-divider">|</span>
                <span id="totalCost">0 kr</span>
            </div>
            <div class="charging-start" id="chargingStart">Indl√¶ser...</div>
        </div>
    </div>

    <div id="tooltipPortal" class="tooltip-portal"></div>

<script>
    // ==============================================
    // FASE 2 FIXED: SIMPLE DATA FLOW + FALLBACK
    // ==============================================

    // GLOBAL STATE (samme som Fase 1 - virkede!)
    let currentDay = 'today';
    let currentTeslaData = null;
    let refreshTimer = null;
    let isPageVisible = true;
    let hasLiveTeslaData = false;

    // KONFIGURATION
    const CONFIG = {
        refreshInterval: 60000,
        retryAttempts: 3,
        retryDelay: 2000,
        dataURL: 'https://gist.githubusercontent.com/boellehuus/ac3fe4331b033d941cdc836936d4c3c9/raw/elbil-data.json',
        billigkwhURL: 'https://billigkwh.dk/api/Priser/HentPriser?sted=DK1&netselskab=vores_elnet&produkt=greenbow_elaftale',
        exchangeRateURL: 'https://api.exchangerate-api.com/v4/latest/EUR',
        exchangeRateFallback: 7.44,
        cachedEURRate: 7.44,
        lastRateUpdate: null
    };

    // DATA STRUKTURER (samme som Fase 1 - virkede!)
    const priceDataSet = { today: [], tomorrow: [] };
    const chargingSchedule = { today: [], tomorrow: [] };
    let priceData = [];

    console.log('üîÑ FASE 2 FIXED: Tesla Dashboard med simple data flow...');

    // Ekspon√©r switchDay funktion √∏jeblikkeligt
    window.switchDay = function(day) {
        try {
            console.log('üîÑ Switching to day:', day);
            
            // Update active button
            document.querySelectorAll('.time-option').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate correct button
            const buttons = document.querySelectorAll('.time-option');
            buttons.forEach(btn => {
                if ((day === 'today' && btn.textContent.includes('I dag')) ||
                    (day === 'tomorrow' && btn.textContent.includes('morgen'))) {
                    btn.classList.add('active');
                }
            });
            
            // Update current day
            currentDay = day;
            
            // Update data (FASE 1 STYLE - SIMPLE!)
            priceData = priceDataSet[day] || [];
            
            console.log(`‚úÖ Switched to ${day}:`, priceData.length, 'prices');
            
            // Regenerate chart
            generateChart();
            
        } catch (error) {
            console.error('‚ùå Error switching day:', error);
            priceData = [];
            generateChart();
        }
    };

    // ==============================================
    // FASE 2: BILLIGKWH FALLBACK (FORENKLET)
    // ==============================================

    async function fetchBilligkWhData() {
        try {
            console.log('‚ö° Fetching BilligkWh fallback data...');
            
            const response = await fetch(CONFIG.billigkwhURL + '&t=' + Date.now());
            if (!response.ok) throw new Error(`BilligkWh HTTP ${response.status}`);
            
            const data = await response.json();
            console.log('‚úÖ BilligkWh data received:', data.length, 'days');
            
            // SIMPLE processing - lige som Fase 1
            return await processBilligkWhData(data);
            
        } catch (error) {
            console.warn('‚ö†Ô∏è BilligkWh fetch failed:', error.message);
            return null;
        }
    }

    async function processBilligkWhData(rawData) {
        try {
            const result = { today: [], tomorrow: [] };
            const now = new Date();
            const copenhagenNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Copenhagen"}));
            const todayDateStr = copenhagenNow.toISOString().split('T')[0];
            const tomorrowDate = new Date(copenhagenNow);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            const tomorrowDateStr = tomorrowDate.toISOString().split('T')[0];

            const eurRate = await fetchExchangeRate();

            for (const dayData of rawData) {
                if (!dayData.Dato || !dayData.Priser) continue;

                const dataDate = dayData.Dato.split('T')[0];
                let targetArray = null;
                
                if (dataDate === todayDateStr) {
                    targetArray = result.today;
                } else if (dataDate === tomorrowDateStr) {
                    targetArray = result.tomorrow;
                }

                if (targetArray && Array.isArray(dayData.Priser)) {
                    const sortedPrices = dayData.Priser
                        .sort((a, b) => a.StartTid.localeCompare(b.StartTid))
                        .map(pricePoint => {
                            const eurPrice = parseFloat(pricePoint.Pris) || 0;
                            const dkkPrice = (eurPrice / 1000) * eurRate;
                            return Math.round(dkkPrice * 1000) / 1000;
                        });

                    while (sortedPrices.length < 24) {
                        sortedPrices.push(sortedPrices[sortedPrices.length - 1] || 2.5);
                    }

                    targetArray.splice(0, 24, ...sortedPrices.slice(0, 24));
                }
            }

            return result;

        } catch (error) {
            console.error('‚ùå Error processing BilligkWh data:', error);
            return null;
        }
    }

    async function fetchExchangeRate() {
        try {
            const now = new Date();
            const lastUpdate = CONFIG.lastRateUpdate;
            
            if (lastUpdate && (now - lastUpdate) < 24 * 60 * 60 * 1000) {
                return CONFIG.cachedEURRate;
            }
            
            const response = await fetch(CONFIG.exchangeRateURL + '?t=' + Date.now());
            
            if (response.ok) {
                const data = await response.json();
                if (data.rates && data.rates.DKK) {
                    const eurRate = parseFloat(data.rates.DKK);
                    if (eurRate > 6 && eurRate < 9) {
                        CONFIG.cachedEURRate = eurRate;
                        CONFIG.lastRateUpdate = now;
                        return eurRate;
                    }
                }
            }
            
            throw new Error('Invalid API response');
            
        } catch (error) {
            console.warn('‚ö†Ô∏è EUR rate fetch failed, using fallback:', CONFIG.exchangeRateFallback);
            return CONFIG.exchangeRateFallback;
        }
    }

    // ==============================================
    // TESLA DATA (FASE 1 STYLE - SIMPLE!)
    // ==============================================

    async function fetchTeslaData() {
        try {
            console.log('üîÑ Fetching Tesla data...');
            
            const teslaResponse = await fetch(CONFIG.dataURL + '?t=' + Date.now());
            
            if (!teslaResponse.ok) {
                throw new Error(`Tesla HTTP ${teslaResponse.status}`);
            }
            
            const teslaData = await teslaResponse.json();
            console.log('‚úÖ Tesla data received');
            
            // FASE 1 STYLE - DIRECT UPDATE!
            updateUIWithTeslaData(teslaData);
            
            if (!refreshTimer) {
                refreshTimer = setInterval(fetchTeslaData, CONFIG.refreshInterval);
                console.log('üîÑ Auto-refresh timer started');
            }
            
        } catch (error) {
            console.error('‚ùå Tesla data fetch error:', error);
            
            // FASE 2: Fallback til BilligkWh
            await attemptBilligkWhFallback();
        }
    }

    // FASE 2: Fallback system
    async function attemptBilligkWhFallback() {
        try {
            console.log('üîÑ Attempting BilligkWh fallback...');
            
            const billigkWhData = await fetchBilligkWhData();
            
            if (billigkWhData) {
                console.log('‚úÖ BilligkWh fallback successful');
                
                // FASE 1 STYLE - DIRECT UPDATE!
                priceDataSet.today = billigkWhData.today;
                priceDataSet.tomorrow = billigkWhData.tomorrow;
                
                // Clear Tesla-specific data
                document.getElementById('totalCost').textContent = 'N/A';
                document.getElementById('kWhNeeded').textContent = 'N/A';
                document.getElementById('chargingStart').textContent = 'Kun priser tilg√¶ngelige';
                
                chargingSchedule.today = [];
                chargingSchedule.tomorrow = [];
                
                updateDataSourceIndicator('BilligkWh (backup)', false);
                
                // FASE 1 STYLE - SIMPLE UPDATE!
                priceData = priceDataSet[currentDay] || [];
                generateChart();
                
            } else {
                throw new Error('BilligkWh fallback failed');
            }
            
        } catch (error) {
            console.error('‚ùå Complete data failure:', error);
            handleFetchError(error);
        }
    }

    // FASE 1 STYLE - updateUIWithTeslaData (samme som virkede!)
    function updateUIWithTeslaData(teslaData) {
        console.log('üîÑ Updating UI with Tesla data...');
        
        currentTeslaData = teslaData;
        hasLiveTeslaData = true;
        
        updateSummaryInfo(teslaData);
        updatePriceDataSet(teslaData);
        updateChargingHours(teslaData);
        updateDataSourceIndicator('Tesla', true);
        
        // FASE 1 STYLE - DIRECT!
        priceData = priceDataSet[currentDay] || [];
        generateChart();
        
        console.log('‚úÖ Tesla UI update completed');
    }

    // FASE 1 STYLE - updatePriceDataSet (samme som virkede!)
    function updatePriceDataSet(teslaData) {
        console.log('üîÑ Updating price data set...');
        
        if (teslaData.Elbil_price_data && Array.isArray(teslaData.Elbil_price_data)) {
            priceDataSet.today = teslaData.Elbil_price_data;
            console.log('‚úÖ Today prices loaded:', priceDataSet.today.length, 'hours');
        } else {
            priceDataSet.today = [];
        }
        
        if (teslaData.Elbil_price_data_tomorrow && Array.isArray(teslaData.Elbil_price_data_tomorrow)) {
            priceDataSet.tomorrow = teslaData.Elbil_price_data_tomorrow;
            console.log('‚úÖ Tomorrow prices loaded:', priceDataSet.tomorrow.length, 'hours');
        } else {
            priceDataSet.tomorrow = [];
        }
        
        console.log('‚úÖ Price data set updated');
    }

    function updateSummaryInfo(teslaData) {
        if (teslaData.Elbil_total_cost !== null && teslaData.Elbil_total_cost !== undefined && teslaData.Elbil_total_cost > 0) {
            document.getElementById('totalCost').textContent = 
                parseFloat(teslaData.Elbil_total_cost).toFixed(2).replace('.', ',') + ' kr';
        } else {
            document.getElementById('totalCost').textContent = '0 kr';
        }
        
        if (teslaData.Elbil_kWh_needed !== null && teslaData.Elbil_kWh_needed !== undefined && teslaData.Elbil_kWh_needed > 0) {
            document.getElementById('kWhNeeded').textContent = 
                parseFloat(teslaData.Elbil_kWh_needed).toFixed(2).replace('.', ',') + ' kWh';
        } else {
            document.getElementById('kWhNeeded').textContent = '0 kWh';
        }
        
        if (teslaData.Elbil_compact_schedule && teslaData.Elbil_compact_schedule !== '') {
            document.getElementById('chargingStart').textContent = teslaData.Elbil_compact_schedule;
        } else {
            document.getElementById('chargingStart').textContent = 'Ladning ikke planlagt';
        }
    }

    function updateChargingHours(teslaData) {
        chargingSchedule.today = [];
        chargingSchedule.tomorrow = [];
        
        if (teslaData.Elbil_optimal_start_time && teslaData.Elbil_charging_hours && teslaData.Elbil_compact_schedule) {
            try {
                const startTime = teslaData.Elbil_optimal_start_time.toString();
                const chargingHours = parseInt(teslaData.Elbil_charging_hours);
                const schedule = teslaData.Elbil_compact_schedule.toString();
                
                if (startTime.includes(':')) {
                    const startHour = parseInt(startTime.split(':')[0]);
                    
                    let targetDay = 'today';
                    const scheduleLC = schedule.toLowerCase();
                    if (scheduleLC.includes('i morgen')) {
                        targetDay = 'tomorrow';
                    }
                    
                    for (let i = 0; i < chargingHours; i++) {
                        const hour = (startHour + i) % 24;
                        chargingSchedule[targetDay].push(hour);
                    }
                    
                    console.log(`‚ö° Charging scheduled for ${targetDay}:`, chargingSchedule[targetDay]);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not parse charging hours:', error);
            }
        }
    }

    function updateDataSourceIndicator(source, reliable) {
        const sourceElement = document.getElementById('dataSource');
        const reliabilityElement = document.getElementById('reliability');
        
        if (sourceElement) {
            sourceElement.textContent = source;
        }
        
        if (reliabilityElement) {
            reliabilityElement.style.color = reliable ? '#30D158' : '#FF9500';
            reliabilityElement.textContent = reliable ? '‚óè' : '‚óê';
            reliabilityElement.title = reliable ? 'P√•lidelig data' : 'Begr√¶nsede data';
        }
    }

    function handleFetchError(error) {
        hasLiveTeslaData = false;
        priceDataSet.today = [];
        priceDataSet.tomorrow = [];
        priceData = [];
        
        document.getElementById('totalCost').textContent = '0 kr';
        document.getElementById('kWhNeeded').textContent = '0 kWh';
        document.getElementById('chargingStart').textContent = 'Ingen forbindelse';
        
        chargingSchedule.today = [];
        chargingSchedule.tomorrow = [];
        
        updateDataSourceIndicator('Fejl', false);
        generateChart();
    }

    // ==============================================
    // TOOLTIP SYSTEM
    // ==============================================

    const tooltipPortal = document.getElementById('tooltipPortal');
    let activeBar = null;

    function showTooltip(barElement, text) {
        activeBar = barElement;
        const rect = barElement.getBoundingClientRect();
        
        tooltipPortal.textContent = text;
        tooltipPortal.style.left = (rect.left + rect.width / 2) + 'px';
        tooltipPortal.style.top = (rect.top - 8) + 'px';
        tooltipPortal.style.transform = 'translate(-50%, -100%)';
        tooltipPortal.classList.add('visible');
    }

    function hideTooltip() {
        activeBar = null;
        tooltipPortal.classList.remove('visible');
    }

    // ==============================================
    // CHART GENERATION (FASE 1 STYLE - VIRKEDE!)
    // ==============================================

    function generateChart() {
        console.log('üîÑ Generating chart for', currentDay, '- data length:', priceData.length);
        
        const chart = document.getElementById('priceChart');
        chart.innerHTML = '';
        
        if (!priceData || priceData.length === 0) {
            showEmptyState();
            return;
        }
        
        const maxPrice = Math.max(...priceData);
        
        const now = new Date();
        const copenhagenNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Copenhagen"}));
        const currentHour = copenhagenNow.getHours();
        
        priceData.forEach((price, index) => {
            const bar = document.createElement('div');
            bar.className = 'bar';
            
            const height = Math.max((price / maxPrice) * 100, 5);
            bar.style.height = height + '%';
            
            // FASE 2 FIX: Tooltip med 2 decimaler
            const tooltipText = `${index.toString().padStart(2, '0')}:00 - ${price.toFixed(2).replace('.', ',')} kr/kWh`;
            
            bar.addEventListener('mouseenter', function() {
                showTooltip(this, tooltipText);
            });
            
            bar.addEventListener('mouseleave', function() {
                hideTooltip();
            });
            
            bar.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.classList.add('touch-active');
                showTooltip(this, tooltipText);
                
                document.querySelectorAll('.bar').forEach(otherBar => {
                    if (otherBar !== this) {
                        otherBar.classList.remove('touch-active');
                    }
                });
                
                setTimeout(() => {
                    this.classList.remove('touch-active');
                    if (activeBar === this) hideTooltip();
                }, 3000);
            }, { passive: false });
            
            // Bar styling (FASE 1 STYLE)
            const currentChargingHours = chargingSchedule[currentDay] || [];
            const isCharging = currentChargingHours.includes(index);
            const isPastHour = (currentDay === 'today' && index < currentHour);
            const isCurrentTime = (currentDay === 'today' && index === currentHour);
            
            if (isCurrentTime) {
                bar.classList.add('current-time');
            } else if (isCharging) {
                bar.classList.add('charging');
                if (isPastHour) bar.classList.add('past');
            } else {
                if (price < 2.5) {        
                    bar.classList.add('green');
                } else if (price < 3.5) {  
                    bar.classList.add('orange');
                } else {                  
                    bar.classList.add('red');
                }
                
                if (isPastHour) bar.classList.add('past');
            }
            
            chart.appendChild(bar);
        });
        
        console.log('‚úÖ Chart generation completed');
    }

    function showEmptyState() {
        console.log('üîÑ Showing empty state for', currentDay);
        
        const chart = document.getElementById('priceChart');
        
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        
        const mainMessage = document.createElement('div');
        mainMessage.className = 'main-message';
        
        const subMessage = document.createElement('div');
        subMessage.className = 'sub-message';
        
        if (currentDay === 'tomorrow') {
            const now = new Date();
            const copenhagenNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Copenhagen"}));
            const currentHour = copenhagenNow.getHours();
            
            if (currentHour < 13) {
                mainMessage.textContent = 'Ikke klar endnu';
                subMessage.textContent = 'Priser bliver normalt\ntilg√¶ngelige efter kl. 13:00';
            } else {
                mainMessage.textContent = 'Ingen data';
                subMessage.textContent = 'Tesla data ikke tilg√¶ngeligt';
            }
        } else {
            mainMessage.textContent = 'Ingen data';
            subMessage.textContent = 'K√∏r Tesla script for at\ngenerere ladeplan og priser';
        }
        
        emptyState.appendChild(mainMessage);
        emptyState.appendChild(subMessage);
        chart.appendChild(emptyState);
    }

    // ==============================================
    // INITIALIZATION
    // ==============================================

    function init() {
        console.log('üîÑ Initializing Tesla Dashboard - Fase 2 Fixed...');
        
        // Initialize UI
        document.getElementById('totalCost').textContent = '0 kr';
        document.getElementById('kWhNeeded').textContent = '0 kWh';
        document.getElementById('chargingStart').textContent = 'Indl√¶ser...';
        
        updateDataSourceIndicator('Indl√¶ser...', false);
        
        // Clear data structures (FASE 1 STYLE)
        priceDataSet.today = [];
        priceDataSet.tomorrow = [];
        priceData = [];
        
        // Show empty state initially
        generateChart();
        
        // Start data fetching
        fetchTeslaData();
        
        console.log('‚úÖ Tesla Dashboard initialization completed - Fase 2 Fixed');
    }

    // ==============================================
    // EVENT HANDLERS
    // ==============================================

    // Hide tooltip when clicking outside bars
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('bar')) {
            hideTooltip();
        }
    });

    // Handle page visibility for battery optimization
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            isPageVisible = false;
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
                console.log('‚è∏Ô∏è Auto-refresh paused');
            }
        } else {
            isPageVisible = true;
            if (!refreshTimer) {
                refreshTimer = setInterval(fetchTeslaData, CONFIG.refreshInterval);
                console.log('‚ñ∂Ô∏è Auto-refresh resumed');
                fetchTeslaData();
            }
        }
    });

    // Error handling
    window.addEventListener('unhandledrejection', function(event) {
        console.error('üö® Unhandled promise rejection:', event.reason);
    });

    window.addEventListener('error', function(event) {
        console.error('üö® JavaScript error:', event.error);
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', init);

    // Global functions for backward compatibility
    window.generateChart = generateChart;
    window.fetchTeslaData = fetchTeslaData;

    // Debug interface
    window.debugDashboard = {
        config: () => CONFIG,
        priceData: () => priceDataSet,
        currentData: () => priceData,
        charging: () => chargingSchedule,
        teslaData: () => currentTeslaData,
        refresh: fetchTeslaData,
        fallback: attemptBilligkWhFallback
    };

    console.log('');
    console.log('‚úÖ ================================================');
    console.log('‚úÖ FASE 2 FIXED: Simple data flow + fallback system');
    console.log('‚úÖ ================================================');
    console.log('üîß FIXED: Tooltip shows 2 decimaler (2,13 kr/kWh)');
    console.log('üîß FIXED: switchDay function error resolved');
    console.log('üîß KEPT: Fase 1 simple data flow (virkede!)');
    console.log('üîß ADDED: BilligkWh fallback system');
    console.log('‚úÖ ================================================');
    console.log('üéØ READY: Chart bars should now be visible');
    console.log('üìä FEATURES: Tesla ‚Üí BilligkWh fallback');
    console.log('üîß DEBUG: Use debugDashboard for troubleshooting');
    console.log('‚úÖ ================================================');
